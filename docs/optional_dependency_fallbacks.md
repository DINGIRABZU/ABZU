# Optional Dependency Fallback Matrix

This matrix inventories optional components across Spiral OS subsystems and documents how each module degrades when a dependency is unavailable. Every entry links to the runtime fallback logic so rehearsal leads can assess operational impact and capture mitigation steps in the evidence bundle.

## Avatar expression and video pipeline

| Component | Missing behaviour | Impact | Mitigation |
| --- | --- | --- | --- |
| SadTalker | When the pipeline cannot be constructed, `generate_avatar_stream` falls back to procedurally generated frames and skips SadTalker-driven lip sequences.【F:src/core/video_engine.py†L26-L338】 | Stage lip-sync reverts to the 2D expression loop without 3D animation fidelity.【F:src/core/video_engine.py†L182-L205】 | Install the SadTalker extra or document the simplified render in the rehearsal evidence bundle.
| wav2lip | If the predictor stub is in use the video engine skips audio-conditioned synthesis; the avatar expression stream applies only amplitude overlays instead.【F:src/core/video_engine.py†L26-L338】【F:src/core/avatar_expression_engine.py†L77-L97】 | Lip motion desynchronises from speech because only the basic mouth mask is rendered.【F:src/core/avatar_expression_engine.py†L61-L97】 | Pin the `wav2lip` extra before shows or record the downgraded quality and remediation plan.
| librosa | Stubbed imports disable audio loading for lip sync and raise runtime errors in the expression streamer.【F:src/core/video_engine.py†L40-L313】【F:src/core/avatar_expression_engine.py†L65-L97】 | Audio-driven cues fail entirely; advanced overlay logic cannot run.【F:src/core/avatar_expression_engine.py†L65-L97】 | Provision the `librosa` extra during staging and keep fallback notes when operating in silent mode.
| MediaPipe | Without MediaPipe the face mesh helper returns `None`, so expression pipelines skip landmark refinement.【F:src/core/video_engine.py†L55-L197】 | Facial tracking loses mesh-derived smoothing; overlays are applied without landmark feedback.【F:src/core/video_engine.py†L142-L197】 | Re-enable MediaPipe on demo rigs or log the diminished expression fidelity.
| ControlNet | Gesture injection is bypassed when ControlNet is absent; AnimateDiff is attempted next, otherwise gestures are omitted.【F:src/core/video_engine.py†L59-L357】 | Avatar gesture cues are lost, yielding static upper-body movement.【F:src/core/video_engine.py†L348-L357】 | Stage rehearsals should either install ControlNet/AnimateDiff or script compensating choreography.
| AnimateDiff | If both ControlNet and AnimateDiff are missing the gesture loop does nothing, leaving only core expression output.【F:src/core/video_engine.py†L59-L357】 | Gestural nuance disappears from camera paths.【F:src/core/video_engine.py†L348-L357】 | Capture the gap in the evidence bundle and align alternate blocking with the Stage C creative team.
| OpenCV (`cv2`) | Upscaling and video capture fall back to NumPy repeats and video storage fails for physical events.【F:src/core/video_engine.py†L22-L155】【F:src/core/memory_physical.py†L58-L78】 | Frame quality softens and physical video samples cannot be archived.【F:src/core/memory_physical.py†L58-L78】 | Reinstall the `opencv` extra or substitute high-resolution pre-renders until the dependency is restored.
| vector_memory | Trait overrides are skipped when the optional vector store is unavailable, keeping only default avatar traits.【F:src/core/video_engine.py†L49-L139】 | Scene-specific sigils, skins, and colour overrides never materialise.【F:src/core/video_engine.py†L100-L139】 | Refresh vector memory connectivity or annotate the missing personalization in rehearsal notes.
| lwm | If the lightweight world model cannot be imported the engine uses a stub that returns an empty scene.【F:src/core/video_engine.py†L17-L299】 | Camera path automation is unavailable, requiring manual path configuration.【F:src/core/video_engine.py†L289-L328】 | Restore `lwm` for automatic paths or script manual camera cues in the evidence bundle.

## Audio capture, synthesis, and playback

| Component | Missing behaviour | Impact | Mitigation |
| --- | --- | --- | --- |
| sounddevice | Speaking playback logs a warning and aborts, microphone capture raises runtime errors, and voice cloning produces silence when the stub is active.【F:INANNA_AI/speaking_engine.py†L34-L169】【F:INANNA_AI/listening_engine.py†L29-L236】【F:src/audio/voice_cloner.py†L55-L74】 | Live rehearsal audio cannot be recorded or played back, forcing silent fallbacks.【F:INANNA_AI/listening_engine.py†L152-L236】【F:src/audio/voice_cloner.py†L55-L105】 | Provision ALSA headers and install `sounddevice`; if unavailable, document silent-mode rehearsals and capture mitigation steps.
| opensmile | Emotion analysis skips acoustic feature extraction and falls back to heuristic thresholds when OpenSMILE is missing.【F:INANNA_AI/listening_engine.py†L21-L145】 | Sentiment weights lose arousal/valence precision, reducing telemetry fidelity.【F:INANNA_AI/listening_engine.py†L88-L145】 | Install the `opensmile` extra or record the reduced metrics coverage in Stage B logs.
| websockets | The streaming server raises a runtime error when the WebSockets module is absent.【F:INANNA_AI/listening_engine.py†L25-L270】 | Remote dashboards cannot receive live listening telemetry.【F:INANNA_AI/listening_engine.py†L254-L270】 | Re-enable the dependency or capture offline exports for stakeholders.
| gTTS | Speech synthesis falls back to generating a sine-wave placeholder when gTTS cannot be imported or fails at runtime.【F:INANNA_AI/speaking_engine.py†L27-L124】 | Spoken prompts lose intelligibility, offering only tonal stand-ins.【F:INANNA_AI/speaking_engine.py†L102-L124】 | Install gTTS or switch to another configured backend; document placeholder usage during rehearsals.
| OpenVoice | Without OpenVoice the engine reverts to simple pitch-shift voice conversion driven by `librosa` effects.【F:INANNA_AI/speaking_engine.py†L50-L63】 | Timbre morphing is constrained to coarse pitch offsets.【F:INANNA_AI/speaking_engine.py†L50-L63】 | Restore OpenVoice for full timbre control or align expectations with the simplified effect.
| librosa | Stubbed imports trigger runtime failures in synthesis, listening, and audio utility helpers, halting feature extraction and file IO.【F:INANNA_AI/speaking_engine.py†L15-L124】【F:INANNA_AI/listening_engine.py†L17-L250】【F:INANNA_AI/utils.py†L32-L47】 | Tempo tracking, pitch analysis, and WAV persistence fail, blocking avatar lip sync and analytics.【F:INANNA_AI/listening_engine.py†L63-L250】【F:INANNA_AI/utils.py†L32-L47】 | Ensure the `librosa` extra is installed before rehearsals or capture the disabled analytics in the evidence bundle.
| soundfile | WAV export, MOS scoring, DSP filters, and NumPy segment I/O raise runtime errors when soundfile is missing.【F:INANNA_AI/utils.py†L40-L47】【F:src/audio/voice_cloner.py†L100-L134】【F:src/audio/segment.py†L86-L111】【F:src/audio/dsp_engine.py†L13-L66】 | Audio assets cannot be saved or processed, degrading rehearsal artefact quality.【F:src/audio/voice_cloner.py†L100-L134】【F:src/audio/dsp_engine.py†L42-L87】 | Install the `soundfile` extra or document alternative capture strategies in Stage B artefacts.
| pydub / FFmpeg | The audio segment resolver drops to the NumPy backend when pydub or FFmpeg is absent, logging errors and reducing feature coverage.【F:src/audio/segment.py†L45-L184】 | Playback and mixing still work but with simplified DSP and no direct FFmpeg pipeline; the playback engine refuses to run without FFmpeg binaries.【F:src/audio/engine.py†L51-L235】 | Restore FFmpeg and the `pydub` extra or highlight the reduced mix controls during rehearsals.
| simpleaudio | When simpleaudio cannot be imported the playback engine raises runtime errors and emits failure telemetry for direct buffer playback.【F:src/audio/engine.py†L37-L162】 | Single-shot playback cannot occur outside the pydub helper path.【F:src/audio/engine.py†L129-L235】 | Ship the `audio` extras bundle or log the playback limitation and use looped cues.
| EmotiVoice | Voice cloning generates silent placeholders and reports a baseline MOS when EmotiVoice is stubbed.【F:src/audio/voice_cloner.py†L100-L134】 | Cloned speech is unusable for demonstrations.【F:src/audio/voice_cloner.py†L100-L134】 | Reinstall EmotiVoice or pre-record narration; include the workaround in the evidence bundle.
| RAVE / torch | RAVE encode/decode helpers raise runtime errors when either dependency is missing.【F:src/audio/dsp_engine.py†L19-L127】 | Neural morphing and latent mixing are unavailable.【F:src/audio/dsp_engine.py†L95-L127】 | Deploy the RAVE checkpoint dependencies or document the disabled feature set.
| NSynth | NSynth interpolation raises a runtime error without the Magenta fastgen module.【F:src/audio/dsp_engine.py†L26-L144】 | Cross-timbral interpolation is skipped entirely.【F:src/audio/dsp_engine.py†L134-L144】 | Install NSynth tooling or capture the omission in the rehearsal bundle.

## Memory, learning, and analytics subsystems

| Component | Missing behaviour | Impact | Mitigation |
| --- | --- | --- | --- |
| numpy / gymnasium / stable-baselines3 | The lazy importer supplies stubs that disable reinforcement learning environments and emit warnings; RL updates are skipped entirely when any dependency is absent.【F:src/core/utils/optional_deps.py†L16-L134】【F:memory/context_env.py†L6-L67】【F:memory/mental.py†L35-L124】 | Context learning cannot train or update replay buffers, reducing adaptive behaviour.【F:memory/mental.py†L96-L124】 | Install the RL extras before adaptive runs or record that the rehearsal executed in static-policy mode.
| neo4j | Missing drivers raise runtime errors when establishing the task memory connection, blocking persistence.【F:memory/mental.py†L17-L105】 | Task flows cannot be stored, breaking narrative telemetry.【F:memory/mental.py†L82-L151】 | Bring Neo4j online or note the absence of mental memory updates for auditors.
| torch (Gate Orchestrator) | Instantiating the orchestrator raises a runtime error without torch; the LSTM selector cannot load.【F:INANNA_AI/gate_orchestrator.py†L14-L59】 | Automatic LLM selection reverts to the baseline `glm` path.【F:INANNA_AI/gate_orchestrator.py†L47-L176】 | Install the `pytorch` extra or document manual model routing decisions.
| vanna | Training helpers short-circuit and the query APIs raise when vanna is stubbed or unconfigured.【F:nlq_api.py†L13-L58】【F:agents/vanna_data.py†L23-L127】 | Natural-language data queries are disabled, blocking analytics rehearsals.【F:agents/vanna_data.py†L77-L127】 | Restore the Vanna connection or capture alternate query workflows for reviewers.

## Physical memory and transcription

| Component | Missing behaviour | Impact | Mitigation |
| --- | --- | --- | --- |
| OpenCV (`cv2`) | Video events raise runtime errors because frames cannot be written without OpenCV.【F:src/core/memory_physical.py†L58-L65】 | Physical video evidence is lost from the rehearsal archive.【F:src/core/memory_physical.py†L58-L65】 | Install the `opencv` extra or replace video capture with pre-rendered assets and document the gap.
| librosa | Audio events raise runtime errors when librosa is missing, preventing normalisation before storage.【F:src/core/memory_physical.py†L65-L78】 | Raw microphone captures are not persisted to the physical memory ledger.【F:src/core/memory_physical.py†L65-L78】 | Provision librosa on ingest hosts or log the unrecorded streams for stakeholders.
| whisper | Transcription is skipped when Whisper is unavailable; failures are logged but do not block storage.【F:src/core/memory_physical.py†L79-L85】 | Evidence bundles lack automated transcripts, increasing manual review time.【F:src/core/memory_physical.py†L79-L85】 | Install Whisper or attach manual transcriptions to the rehearsal package.
| soundfile | Audio storage raises a runtime error if soundfile is absent during physical event persistence.【F:src/core/memory_physical.py†L70-L78】 | Physical audio cannot be archived, degrading forensic coverage.【F:src/core/memory_physical.py†L70-L78】 | Deploy the soundfile extra or capture alternate recordings and note the workaround.

