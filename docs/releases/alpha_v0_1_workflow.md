# Alpha v0.1 Workflow Gate

Alpha v0.1 establishes the first end-to-end readiness gate for the Spiral OS
stack. This workflow packages the build, verifies core health probes, and runs
the acceptance tests required to promote a candidate into the operator staging
loop documented in [alpha_v0_1_charter.md](../alpha_v0_1_charter.md) and the
[roadmap](../roadmap.md#alpha-v01-execution-plan).

## Prerequisites

- Complete the release preparation steps in
  [release_runbook.md](../release_runbook.md).
- Ensure the environment validation secrets (`GLM_API_URL`, `GLM_API_KEY`,
  `HF_TOKEN`) are exported or populated in `secrets.env`.
- Install Python build tooling (`python -m pip install build`) and make sure the
  repository root is clean (`git status` shows no pending changes).

## Build Packaging

Alpha promotion requires a reproducible artifact bundle.

1. Clean the previous build output:
   ```bash
   rm -rf dist/
   ```
2. Build the wheel artifact:
   ```bash
   python -m build --wheel
   ```
3. Archive the generated wheel and supporting manifests under `release/` and
   cross-check signatures per [release_process.md](../release_process.md).

Successful packaging verifies that the project metadata and dependencies are in
sync before health validation starts.

## Mandatory Health Checks

Run the following checks in order and address any failures before continuing.

1. **Environment and binary validation**
   ```bash
   scripts/check_requirements.sh
   ```
   Confirms required environment variables and binary dependencies are
   available.
2. **Self-healing and quarantine hygiene**
   ```bash
   python scripts/verify_self_healing.py --max-quarantine-hours 24 --max-cycle-hours 24
   ```
   Ensures the self-healing ledger recorded a successful cycle in the last
   24 hours and that no component remains in quarantine beyond the threshold.
3. **Connector heartbeat sweep** (optional but recommended)
   ```bash
   python scripts/health_check_connectors.py
   ```
   Validates `/health` endpoints for configured connectors before running
   acceptance tests. Supply connector URLs via `OPERATOR_API_URL`,
   `WEBRTC_CONNECTOR_URL`, and `PRIMORDIALS_API_URL` as needed.
4. **RAZAR chaos escalation drill** (optional)
   ```bash
   python scripts/razar_chaos_drill.py --dry-run
   ```
   Exercises the Crown → Kimi-cho → K2 Coder → Air Star → rStar ladder,
   verifies `metrics.observe_retry_duration`, and confirms alert runbooks point
   at [docs/runbooks/razar_escalation.md](../runbooks/razar_escalation.md).

## Acceptance Tests

Stage A promotions require a single coverage-enforced pytest invocation that sweeps the Spiral OS boot scripts, RAZAR failover, and Spiral memory/vector entry points:

```bash
pytest --maxfail=1 --cov --cov-fail-under=90 \
  tests/test_start_spiral_os.py \
  tests/test_spiral_os.py \
  tests/integration/test_razar_failover.py \
  tests/test_spiral_memory.py \
  tests/test_vector_memory.py \
  tests/test_vector_memory_extensions.py \
  tests/test_vector_memory_persistence.py \
  tests/test_spiral_vector_db.py
```

The consolidated run ensures the Stage A ≥90 % coverage bar is enforced locally before promotion. Logs and coverage artifacts generated by the gate must be archived under `logs/alpha_gate/`.

### Minimal Spiral OS Boot Scripts

- Covered by the Stage A suite above; these tests validate the boot diagnostics pipeline, ensure optional subsystems degrade gracefully, and confirm the CLI entry points align with [start_spiral_os.py](../../start_spiral_os.py).

### RAZAR Failover Validation

- Exercised within the Stage A suite; the integration test asserts the boot orchestrator escalates through Crown → Kimi-cho → K2 Coder → Air Star → rStar, applies custom failover orders, and logs telemetry for `monitoring/razar_failover.json` dashboards.

### Nazarick / Memory Regression Sweep (Mandatory)

- Also included in the Stage A suite via the Spiral memory and vector regression tests listed above. These confirm memory layer read/write paths continue to operate during boot and failover exercises and guard against regressions in the Nazarick interfaces.

## Automation

Use `scripts/run_alpha_gate.sh` to orchestrate the full workflow. The helper
script performs packaging, health checks, and test execution with structured
logging.

```bash
./scripts/run_alpha_gate.sh
```

Pass `--skip-build`, `--skip-health`, or `--skip-tests` to bypass individual
phases when rerunning investigations. Use `--run-chaos-drill` to execute the
dry-run escalation drill during the health phase. The script exits with a
non-zero status if any phase fails and writes consolidated logs to
`logs/alpha_gate/` for review.

## CI Integration

- GitHub Actions workflow: `.github/workflows/alpha_gate.yml`.
- Triggers: push events targeting `main`, weekly Monday 06:00 UTC schedule,
  and manual `workflow_dispatch` runs when an operator wants to gate a
  specific commit.
- Environment preparation: restores cached `dist/` wheels, installs runtime and
  test dependencies, and boots a lightweight mock connector server so
  `--check-connectors` probes succeed in CI.
- Artifacts: uploads `logs/alpha_gate/` (including the timestamped
  `CHANGELOG.md` snippet) and the freshly built `dist/` wheel for auditing.
- Pipeline mirror: `deployment/pipelines/alpha_gate.yml` enables `spiral-os
  pipeline deploy deployment/pipelines/alpha_gate.yml` for local rehearsal.

## Troubleshooting

- Inspect the `alpha-gate-logs` artifact first; `build.log`,
  `health_checks.log`, and `tests.log` include timestamped entries for each
  phase.
- Failures during connector probes usually mean the mock server was not
  running. Re-run locally with `python -m http.server 8000` and create a `health`
  file to mirror the CI setup before invoking the gate.
- Packaging issues can be reproduced by running `python -m build --wheel`
  directly; cached `dist/` artifacts are restored automatically on reruns but
  are safe to delete if a rebuild is required.

## Version History

- 2025-03-01: Initial workflow capturing alpha gate packaging, health checks,
  and acceptance coverage.
